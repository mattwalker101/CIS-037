/* Homework 11.11
 * Matthew Walker, Windows VS2012
 * Write statements to initialize a file, write 10 records, update a record, and delete a record
 * NOT WORKING YET!!
 */

#include <stdio.h>
#include <string.h>

#define FILENAME "nameage.txt"

struct person {
	char lastName[ 15 ];
	char firstName[ 15 ];
	char age[ 4 ];
};

int menuOptions( void );
void createBlank( void );
void updateRecord( void );
void addTenRecord( void );
void deleteRecord( void );
void showFile( void );


int main()
{

	int choice;

	while ( ( choice = menuOptions() ) != 5 ) {
		switch( choice ) {
		case 1:
			createBlank();	//create a text file with 100 blank entries
			showFile();
			break;
		case 2:
			updateRecord();  // change values in one record 
			showFile();
			break;
		case 3:
			addTenRecord();  // append 10 entries with user input
			showFile();
			break;
		case 4:
			deleteRecord(); // delete a record specified by user
			showFile();
			break;
		default:
			puts( "Invalid choice!\n" );
			break;
		}
	}

	return 0;
}

void createBlank( void )     // a) Initialize the file with 100 blank entries
{
	FILE *createPtr;
	int i;
	struct person pData = { "unassigned", "", "0" };

	if ( ( createPtr = fopen( FILENAME, "w+" ) ) == NULL ) {
		puts( "File could not be opened.\n" );
	} else { // initialize with 100 blank records
		for ( i = 0; i < 10; i++ ) {
			fwrite( &pData, sizeof( pData ), 1, createPtr );
		}
	}

	fclose( createPtr );
}


void addTenRecord( void )   // b) Input 10 last names, first names and ages, and write them to the file
{
	FILE *addPtr;
	int i;
	struct person pData;
	
	if ( ( addPtr = fopen( FILENAME, "a+" ) ) == NULL ) {
		puts( "Cannot open the file to append!\n" );
	} else {
		for ( i = 0; i < 2; i++ ) { // loop 10 times
			printf( "Enter the last name to be added: " );
			scanf( "%s", &pData.lastName );  // store user data in struct pData
	
			printf( "Enter the first name to be added: " );
			scanf( "%s", &pData.firstName );

			printf( "Enter the age to be added: " );
			scanf( "%s", &pData.age );

			// write all the data to the file using pointer to file cfPtr
			fwrite( &pData, sizeof( pData ), 1, addPtr );
		}

		fclose( addPtr );
	}
}


void updateRecord( void )    // c) update a record
{
	FILE *updatePtr;
	struct person pData;
	struct person updateData;
	char lName[ 15 ];
	int stop, counter = 0;

	if ( ( updatePtr = fopen( FILENAME, "r+" ) ) == NULL ) {
		puts( "Trouble opening file for updating!\n" );
	} else {
		printf( "Enter the last name of the person whose record you wish to update: " );
		scanf( "%s", &lName );

		while ( !feof( updatePtr ) ) {		// scan each record into pData until EOF
			fread( &pData, sizeof( pData ), 1, updatePtr  );
			counter++;
			if ( strcmp ( pData.lastName, lName ) == 0 ) { // when there is a match...
				printf( "Enter the new data for that record : \n\n" );
				printf( "\nEnter the lastname for that record : " );
				scanf( "%s", &updateData.lastName );
				printf( "\nEnter the firstname for that record : " );
				scanf( "%s", &updateData.firstName );
				printf( "\nEnter the age for that record : " );
				scanf( "%s", &updateData.age );
				stop = counter;		// mark the location of the match
				break;
			}
		}

		fclose( updatePtr );
		if ( ( updatePtr = fopen( FILENAME, "r+" ) ) == NULL ) {
			puts( "Trouble opening file for updating!\n" );
		} else {
		
			for ( counter = 0; counter < stop; counter++ ) {  // scan through file contents up to stop point
				fread( &pData, sizeof( pData ), 1, updatePtr  );
			}

			fwrite( &updateData, sizeof( updateData ), 1, updatePtr );  // write the new data to that location
		}
	}
	fclose( updatePtr );
	
}

void deleteRecord( void )       // d) delete a record
{
	FILE *deletePtr;
	struct person pData;
	char lName[ 15 ];
	int count;
	struct person emptyData = { "unassigned", "", "0" };

	if ( ( deletePtr = fopen( FILENAME, "r+" ) ) ==NULL ) {
		puts( "Problem opening the file for deletion!\n" );
	} else {
		printf( "Enter the last name of the record you wish to delete : " );
		scanf( "%s", &lName );

		fread( &pData, sizeof( pData ), 1, deletePtr );
		// while ( !feof( deletePtr ) ) {
		for ( count = 0; count < 20; count++ ) {
			printf("\nInside the while for fgets : %d times in", count );
			fread( &pData, sizeof( pData ), 1, deletePtr );
			if ( strcmp ( pData.lastName, lName ) == 0 ) { // when there is a match...
				printf("\nInside the if to compare last names");
				fwrite( &emptyData, sizeof( emptyData ), 1, deletePtr ); 
				printf("\n did fwrite");
			}
	// 	}
		}
		fclose( deletePtr );

	}
}

int menuOptions( void )
{
	int mChoice; 

	printf( "\n===========================\nWhat would you like to do today?\n\n" 
			"(1) to create a blank text file and add 10 blank entries,\n" 
			"(2) to update a single record,\n"
			"(3) to add 2 user generated records,\n"
			"(4) to delete a single record, or\n"
			"(5) to end the program.\n" );
	scanf( "%d", &mChoice );
	return mChoice;
}

void showFile( void )
{
	FILE *showPtr;
	struct person pData;

	if ( ( showPtr = fopen( FILENAME, "r" ) ) == NULL ) {
		puts( "Can't open file for display!\n" );
	} else {
		while ( fread( &pData, sizeof( pData ), 1, showPtr ) ) {
			printf( "%-16s%-16s%-5s\n", pData.lastName, pData.firstName, pData.age );
		}
	}
	fclose( showPtr );
}

